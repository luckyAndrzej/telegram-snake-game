# –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞: –õ–æ–≥–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∞–≥–æ–≤

## 1. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ requestWithdraw

**–§–∞–π–ª:** `server.js` (—Å—Ç—Ä–æ–∫–∏ 252-440)

### –¢–µ–∫—É—â–∏–π –∫–æ–¥ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞:

```javascript
socket.on('requestWithdraw', async (data) => {
  console.log('üì• –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–≤–æ–¥ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userId); // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û
  console.log('   –î–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞:', data); // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û
  
  try {
    const { amount } = data;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–ª–∞–Ω—Å–∞, –∫–æ—à–µ–ª—å–∫–∞...
    
    // TON SDK –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    const adminSeed = process.env.ADMIN_SEED;
    console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ ADMIN_SEED:', !!adminSeed, adminSeed ? '(–∑–∞–≥—Ä—É–∂–µ–Ω)' : '(–Ω–µ –Ω–∞–π–¥–µ–Ω)');
    
    if (adminSeed && !DEBUG_MODE) {
      // ... —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞ ...
      
      console.log(`üîê Seed-—Ñ—Ä–∞–∑–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞: ${!!adminSeed}`); // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û
      const balance = await client.getBalance(walletAddress);
      const balanceInTon = parseFloat(balance.toString()) / 1000000000;
      console.log(`üí∞ –ë–∞–ª–∞–Ω—Å –∫–æ—à–µ–ª—å–∫–∞ –∞–¥–º–∏–Ω–∞: ${balanceInTon} TON`); // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û
      
      // ... –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ...
    }
    
    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ withdrawals.json (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —á–µ—Ä–µ–∑ setImmediate)
    setImmediate(async () => {
      // fs.promises.writeFile - –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç
    });
  }
});
```

### –ü—Ä–æ–≤–µ—Ä–∫–∏:
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –Ω–∞—á–∞–ª–æ —Ñ—É–Ω–∫—Ü–∏–∏
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ seed-—Ñ—Ä–∞–∑—ã –∏ –±–∞–ª–∞–Ω—Å–∞ –¥–æ–±–∞–≤–ª–µ–Ω–æ
- ‚úÖ –û–ø–µ—Ä–∞—Ü–∏–∏ —Å —Ñ–∞–π–ª–∞–º–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ (`fs.promises` –≤ `setImmediate`)

---

## 2. –°–∫–∞–Ω–µ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (scanTransactions)

**–§–∞–π–ª:** `payment/tonPayment.js` (—Å—Ç—Ä–æ–∫–∏ 191-416)

### –ß–∞—Å—Ç–æ—Ç–∞ –≤—ã–∑–æ–≤–∞:
- **–ò–Ω—Ç–µ—Ä–≤–∞–ª:** 20 —Å–µ–∫—É–Ω–¥ (—Å—Ç—Ä–æ–∫–∞ 137 –≤ `server.js`)
- **–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ:** –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —á–µ—Ä–µ–∑ `setImmediate` (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫)

### –û–ø–µ—Ä–∞—Ü–∏–∏ —Å —Ñ–∞–π–ª–∞–º–∏:
```javascript
// ‚úÖ –ê–°–ò–ù–•–†–û–ù–ù–´–ï –æ–ø–µ—Ä–∞—Ü–∏–∏ (–Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç)
const data = await fs.readFile(PROCESSED_TX_FILE, 'utf8');  // fs.promises
await fs.writeFile(PENDING_PAYMENTS_FILE, ...);  // fs.promises
```

**–í—ã–≤–æ–¥:** –°–∫–∞–Ω–µ—Ä –ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç –∏–≥—Ä—É - —Ä–∞–±–æ—Ç–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∫–∞–∂–¥—ã–µ 20 —Å–µ–∫—É–Ω–¥.

---

## 3. –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª (gameLoop.js)

**–§–∞–π–ª:** `game/gameLoop.js`

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:
- ‚úÖ **–ù–ï–¢** `fs.readFileSync`
- ‚úÖ **–ù–ï–¢** `fs.writeFileSync`
- ‚úÖ –¢–æ–ª—å–∫–æ –ª–æ–≥–∏–∫–∞ –∏–≥—Ä—ã (`gameLogic.tick()`)
- ‚úÖ –¢–æ–ª—å–∫–æ –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Socket.io

**–í—ã–≤–æ–¥:** –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª –ù–ï —Å–æ–¥–µ—Ä–∂–∏—Ç –±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å —Ñ–∞–π–ª–∞–º–∏.

---

## 4. –§—Ä–æ–Ω—Ç–µ–Ω–¥: –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –≤—ã–≤–æ–¥

**–§–∞–π–ª:** `public/app.js` (—Å—Ç—Ä–æ–∫–∏ 882-901)

### –¢–µ–∫—É—â–∏–π –∫–æ–¥:

```javascript
const onConfirm = (confirmed) => {
  if (confirmed) {
    console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–≤–æ–¥ —á–µ—Ä–µ–∑ —Å–æ–∫–µ—Ç...', { amount: currentBalance, socketConnected: socket?.connected }); // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û
    
    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏...
    
    if (socket && socket.connected) {
      socket.emit('requestWithdraw', {
        amount: currentBalance
      });
    }
  }
};
```

---

## üîç –ê–ù–ê–õ–ò–ó –ü–†–ò–ß–ò–ù –õ–ê–ì–û–í

### –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:

1. **–°–∫–∞–Ω–µ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (20 —Å–µ–∫—É–Ω–¥):**
   - ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —á–µ—Ä–µ–∑ `setImmediate`
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `fs.promises` (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç)
   - ‚ö†Ô∏è **–ù–û:** –ï—Å–ª–∏ TonCenter API –º–µ–¥–ª–µ–Ω–Ω—ã–π, –º–æ–∂–µ—Ç –≤–ª–∏—è—Ç—å –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

2. **–ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª:**
   - ‚úÖ –ù–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
   - ‚úÖ –ß–∞—Å—Ç–æ—Ç–∞: 6 —Ç–∏–∫–æ–≤/—Å–µ–∫ (166ms –∏–Ω—Ç–µ—Ä–≤–∞–ª)

3. **–û–ø–µ—Ä–∞—Ü–∏–∏ —Å —Ñ–∞–π–ª–∞–º–∏ –≤ requestWithdraw:**
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è `fs.promises` –≤ `setImmediate` (–Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç)

### –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **TonCenter API –∑–∞–ø—Ä–æ—Å—ã:**
   - –°–∫–∞–Ω–µ—Ä –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∫–∞–∂–¥—ã–µ 20 —Å–µ–∫—É–Ω–¥
   - –ï—Å–ª–∏ API –º–µ–¥–ª–µ–Ω–Ω—ã–π (> 1-2 —Å–µ–∫—É–Ω–¥—ã), —ç—Ç–æ –º–æ–∂–µ—Ç –≤–ª–∏—è—Ç—å

2. **Socket.io —Å–æ–±—ã—Ç–∏—è:**
   - –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ `game_state` —Å–æ–±—ã—Ç–∏—è –∫–∞–∂–¥—ã–µ 166ms –º–æ–≥—É—Ç –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞

---

## üîß –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

1. **–£–≤–µ–ª–∏—á–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª —Å–∫–∞–Ω–µ—Ä–∞ –¥–æ 25-30 —Å–µ–∫—É–Ω–¥** (–µ—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –≤ API)
2. **–î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è TonCenter API –æ—Ç–≤–µ—Ç–æ–≤
3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ** - –≤–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ `game_state` —Å–æ–±—ã—Ç–∏–π

---

## üìã –ß–ï–ö–õ–ò–°–¢ –î–õ–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò

- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "Withdraw"
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ `requestWithdraw`
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ TonCenter API (–º–æ–∂–µ—Ç –±—ã—Ç—å > 1 —Å–µ–∫—É–Ω–¥—ã)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ `game_state` —Å–æ–±—ã—Ç–∏–π –≤ —Å–µ–∫—É–Ω–¥—É

